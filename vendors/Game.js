var GAME=GAME||Object.create(null);GAME.Button={Left:0,Middle:0,Right:0};var GAME=GAME||Object.create(null);GAME.Key={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,D0:48,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D7:55,D8:56,D9:57,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,Left:37,Up:38,Right:39,Down:40,Space:32,Backspace:8,Enter:13},GAME.Keyset={AZERTY:[GAME.Key.Q,GAME.Key.Z,GAME.Key.D,GAME.Key.S],QWERTY:[GAME.Key.A,GAME.Key.W,GAME.Key.D,GAME.Key.S],Left:[GAME.Key.A,GAME.Key.Q,GAME.Key.Left],Up:[GAME.Key.Z,GAME.Key.W,GAME.Key.Up],Right:[GAME.Key.D,GAME.Key.Right],Down:[GAME.Key.S,GAME.Key.Down]};var GAME=GAME||Object.create(null);GAME.Loader=function(){this.weight=0,this.tasks=[],GAME.event(this).add("begin").add("progress").add("complete")},GAME.Loader.prototype.push=function(t){var e=Array.prototype.slice.call(arguments,1),n=Function.prototype.bind.apply(GAME.Loader[t],[null].concat(e)),i=new n;return this.weight+=i.weight,this.tasks.push(i),this},GAME.Loader.prototype.start=function(t){var e=this.weight;this.weight=0;var n=this.tasks;this.tasks=[];var i=Object.create(null),o=0,s=0,r=null,u=function(a){a===void 0&&(a=1);var c=o+(r?r.weight:0)*a,h=c/e;return this.progress(h),1===a&&(o=c,s=h),1===a&&1!==s?(r=n.shift(),r.start(i,u)):1===s&&(this.complete(i),t&&t(i)),this}.bind(this);return this.begin(),u(),this},GAME.Loader.deferred=function(t,e){e===void 0&&(e=1),this.weight=e,this.start=t},GAME.Loader.direct=function(t,e){e===void 0&&(e=1),this.weight=e,this.start=function(e,n){t(e),n()}},GAME.Loader.ready=function(){this.weight=1,this.start=function(t,e){$(document).ready(function(){e()})}},GAME.Loader.texture=function(t,e){this.weight=1,this.start=function(n,i){THREE.ImageUtils.loadTexture(e,null,function(e){n[t]=e,i()})}};var GAME=GAME||Object.create(null);GAME.Loop=function(t,e){this.clock=new THREE.Clock,this.timer=t,this.id=null,this.fn=e,this.lastStatTime=null,this.frameCount=0,GAME.event(this).add("fps"),document.hasFocus()&&this.start(),$(window).blur(function(){this.pause()}.bind(this)),$(window).focus(function(){this.start()}.bind(this))},GAME.Loop.repaint=function(){return window.requestAnimationFrame?{set:function(t){return window.requestAnimationFrame(t)},unset:function(t){window.cancelAnimationFrame(t)}}:GAME.Loop.fps(60)},GAME.Loop.frames=function(t){return{set:function(e){return window.setTimeout(e,1e3/t)},unset:function(t){window.clearTimeout(t)}}},GAME.Loop.prototype.stat=function(){this.frameCount+=1;var t=Date.now();null===this.lastStatTime&&(this.lastStatTime=t);var e=t-this.lastStatTime;1e3>e||(this.fps(Math.round(this.frameCount/(e/1e3))),this.lastStatTime=t,this.frameCount=0)},GAME.Loop.prototype.start=function(){return null!==this.id?this:(this.stat(),this.fn.call(this,this.clock.getDelta()),this.id=this.timer.set(function(){this.id=null,this.start()}.bind(this)),this)},GAME.Loop.prototype.pause=function(){return null===this.id?this:(this.clock.stop(),this.timer.unset(this.id),this.id=null,this)},GAME.StateMachine=function(){},GAME.StateMachine.prototype.takeState=function(){var t=this.state;return this.state=null,this.state.sleep&&this.state.sleep(),this.state.zzz=!0,t},GAME.StateMachine.prototype.setState=function(t){return this.state&&this.state.destruct&&this.state.destruct(),this.state=t,this.state&&(this.state.zzz?(this.state.zzz=!1,this.state.wakeUp&&this.state.wakeUp()):this.state.construct&&this.state.construct()),this},GAME.StateMachine.prototype.update=function(){return this.state?this.state.update?(this.state.update.apply(this.state,arguments),this):this:this};var GAME=GAME||Object.create(null);GAME.delayedCallback=function(t){var e=[],n=!1,i=0,o=0,s=function(){n&&i===o&&t.apply(null,Array.prototype.concat.apply([],e))};return{step:function(){var t=i++;return function(){e[t]=Array.prototype.slice.call(arguments),o+=1,s()}},release:function(){n=!0,s()}}};var GAME=GAME||Object.create(null);GAME.event=function(t){return{add:function(e){var n=[];return t[e]=function(t){return"function"==typeof t?n.push(t):n.forEach(function(t,e){e.apply(this,t)}.bind(this,arguments)),this},this}}};var GAME=GAME||Object.create(null);GAME.keyboard=function(){var t=Object.create(null);return $(window).on("keydown",function(e){t[e.keyCode]||(t[e.keyCode]={locked:!1})}),$(window).on("keyup",function(e){delete t[e.keyCode]}),{any:function(t){return t.some(function(t){return this.pressed(t)},this)},pressed:function(e,n){return!t[e]||t[e].locked?!1:(n&&(t[e].locked=!0),!0)}}}();var GAME=GAME||Object.create(null);GAME.mouse=function(){var t,e=Object.create(null),n=new THREE.Vector2,i=new THREE.Vector2,o=null,s=function(t,e){n.x=t.clientX,n.y=t.clientY,e&&(i.x=t.movementX||t.mozMovementX||t.webkitMovementX||0,i.y=t.movementY||t.mozMovementY||t.webkitMovementY||0)},r=function(){o=null,i.x=0,i.y=0};return $(window).on("pointerlockchange, mozpointerlockchange, webkitpointerlockchange",function(){t=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement}),$(window).on("mousedown",function(t){s(t),e[t.which]={locked:!1}}),$(window).on("mouseup",function(t){s(t),delete e[t.which]}),document.addEventListener("mousemove",function(t){o&&clearTimeout(mousestopTimeout),mousestopTimeout=setTimeout(r,50),s(t,!0)},!1),{pointerMode:function(e){return e?(e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock).call(e):e===!1&&(document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock).call(document),t},movement:function(){return i.clone()},position:function(){return n.clone()},pressed:function(t,n){return!e[t]||e[t].locked?!1:(n&&(e[t].locked=!0),!0)}}}();